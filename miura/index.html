<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
    		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	    	<meta name="apple-mobile-web-app-capable" content="yes">

		<title>(miura)デモページ</title>

		<script src="//cdn.8thwall.com/web/aframe/8frame-0.9.0.min.js"></script>
	        <script defer src="//cdn.8thwall.com/web/aframe/aframe-animation-component-5.1.2.min.js"></script>
	        <script src="//cdn.8thwall.com/web/aframe/aframe-extras-4.2.0.min.js"></script>
	    	<script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>

		<!-- 8th Wall API key -->
		<script async src="//apps.8thwall.com/xrweb?appKey=bnWBr8smMOtm8hsLzv1M3AsjyZEPcHize0Tqflu9nYQxqu0yf0fp8mul8iPtRtqb0oR3LW"></script>

		<script src="./js/oauth.min.js"></script>
                <!-- <script src="http://pajhome.org.uk/crypt/md5/sha1.js"></script> -->

		<script>
			/*
                        var consumer_secret_key = "MD2fiy6v6RrPEHU7xSoLBDgJ8QWt4LFCK2cRDbWDaJIOeCr7GM";
                        var oauth_consumer_key = "c3f33vaqNN5xhDRVVXZ4j824T";
                        var oauth_nonce = String(Math.floor((new Date()).getTime()));
                        b64pad = '=';
                        var oauth_signature; // 他の全てのリクエストパラメータと二つの秘密情報を署名アルゴリズムで処理して作成した値を設定します。

                        var paramString = "";
                        paramString = paramString + "oauth_consumer_key=";
                        paramString = paramString + encodeURIComponent(oauth_consumer_key) + "&";
                        paramString = paramString + "oauth_nonce=";
                        paramString = paramString + encodeURIComponent(oauth_nonce) + "&";
                        paramString = paramString + "oauth_signature_method=";
                        paramString = paramString + encodeURIComponent(oauth_signature_method) + "&";
                        paramString = paramString + "oauth_timestamp=";
                        paramString = paramString + encodeURIComponent(oauth_timestamp) + "&";
                        paramString = paramString + "oauth_token=";
                        paramString = paramString + encodeURIComponent(oauth_token) + "&";
                        paramString = paramString + "oauth_version=";
                        paramString = paramString + encodeURIComponent(oauth_version) + "&";
                        paramString = paramString + "status=";
                        paramString = paramString + encodeURIComponent("hello");

                        var baseString = "POST";
                        baseString = baseString + "&";
                        baseString = baseString + "https%3A%2F%2Fapi.twitter.com%2F1%2Fstatuses%2Fupdate.json";
                        baseString = baseString + "&";
                        baseString = baseString + encodeURIComponent(paramString);
                        // encodeURIComponent
                        oauth_signature = b64_hmac_sha1(consumer_secret_key+"&"+oauth_token_secret, baseString);

                        var oauth_signature_method = 'HMAC-SHA1';
                        var oauth_timestamp = Math.floor((new Date()).getTime() / 1000);
                        var oauth_token;
                        var oauth_version = "1.0";
                        */

			function twitter_init(detail) {
		            OAuth.initialize('SyBFiEar-VxM_498UO4pywHi1Z0');
			    OAuth.popup('twitter', function(err, result) {
                                //var image_src = "Content-Transfer-Encoding: base64" + detail;
                                var image_src = detail;
                                        //media_data: image_src
                                var param1 = {
                                    data: {
                                        media_data: "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"
                                    }
                                };
                                //result.post('/1.1/media/upload.json', param1)
                                result.post('https://upload.twitter.com/1.1/media/upload.json', param1)
                                .done(function (response) {
                                    var media_id_ = response.data.media_id_string;
                                    var param = {
                                        data: {
                                            status: "コンニチハ",
                                            media_ids: media_id_
                                        }
                                    };
                                    result.post('/1.1/statuses/update.json', param)
                                    .done(function (response) {
    				        link = "https://twitter.com/intent/tweet?text=SUCCESS " + media_id_;
    				        location.href = link;
                                    })
                                    .fail(function (err) {
                                        //handle error with err
    				        link = "https://twitter.com/intent/tweet?text=ERROR1 " + media_id_;
    				        location.href = link;
                                    });
                                })
                                .fail(function (err) {
    				    link = "https://twitter.com/intent/tweet?text=ERROR3 " + image_src.substr(0, 64);
    				    location.href = link;
                                });

			    })
                            .fail(function(err){
                                //handle error with err
				link = "https://twitter.com/intent/tweet?text=ERROR2";
				location.href = link;
			    });
			}
		        AFRAME.registerComponent('photo-mode', {
		        	init: function() {
		        		const container = document.getElementById('photoModeContainer');
		        		const image = document.getElementById('photoModeImage');
		        		const shutterButton = document.getElementById('shutterButton');
		        		const closeButton = document.getElementById('closeButton');

		        		// Container starts hidden so it isn't visible when the page is still loading
		        		container.style.display = 'block';

				        closeButton.addEventListener('click', () => {
				        	container.classList.remove('photo');
				        })

		        		shutterButton.addEventListener('click', () => {
						// Emit a screenshotrequest to the xrweb component
						this.el.sceneEl.emit('screenshotrequest');

						// Show the flash while the image is being taken
						container.classList.add('flash');
					})

					this.el.sceneEl.addEventListener('screenshotready', e => {
		        			container.classList.remove('flash');
						// If an error occurs while trying to take the screenshot, e.detail will be empty.
						// We could either retry or return control to the user
						if (!e.detail) {
							return;
						}

                                                //twitter_init();
                                                twitter_init(e.detail);

						// e.detail is the base64 representation of the JPEG screenshot
						image.src = 'data:image/jpeg;base64,' + e.detail;
						var a = document.createElement('a');
						a.href = image.src;
						a.download = "download.jpg";
						a.click();

						// Show the photo
						container.classList.add('photo');

						//var link = this.getAttribute('data-link');
						//link = "https://twitter.com/intent/tweet?text=あなたの東京タワーにまつわる思い出を投稿しよう！&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo";
						//link = "https://twitter.com/intent/tweet?text="+message+"あなたの東京タワーにまつわる思い出を投稿しよう！&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo";
						//location.href = link;
		        		})
		        	}
		        })

			AFRAME.registerComponent('tower', {
			    schema: {
			        name: { type: 'string' }
			    },
			    init: function() {
		                    var scene = document.querySelector('a-scene');
				    
		                    var model = document.createElement('a-gltf-model');
                                    model.setAttribute('src', '#ground');
                                    model.setAttribute('id', 'ground');
		                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
			            //model.setAttribute("visible", "false");
		                    scene.appendChild(model);
		                    model = document.createElement('a-gltf-model');
                                    model.setAttribute('src', '#mall');
                                    model.setAttribute('id', 'mall');
		                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
			            model.setAttribute("visible", "false");
		                    scene.appendChild(model);
		                    model = document.createElement('a-gltf-model');
                                    model.setAttribute('src', '#mall_h13');
                                    model.setAttribute('id', 'mall_h13');
		                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
			            model.setAttribute("visible", "false");
		                    scene.appendChild(model);
		                    model = document.createElement('a-gltf-model');
                                    model.setAttribute('src', '#h13_top');
                                    model.setAttribute('id', 'h13_top');
		                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
			            model.setAttribute("visible", "false");
		                    scene.appendChild(model);
		                    for(var i = 1; i <= 33; i++) {
		                        var tower_ = document.createElement('a-gltf-model');
                                        tower_.setAttribute('src', '#tower' + String(i));
                                        tower_.setAttribute('id', 'tower_' + String(i));
		                        tower_.setAttribute('scale', '0.0125 0.0125 0.0125');
			                tower_.setAttribute("visible", "false");
		                        scene.appendChild(tower_);
		                    }

				    document.querySelector('#ground').setAttribute("visible", "true");
				    for(var i = 1; i <= 33; i++) {
					document.querySelector('#tower_'+String(i)).setAttribute("animation", "property: visible; to: true; delay: " + String(250*i) + ";");
				    }
				    document.querySelector('#mall').setAttribute("animation", "property: visible; to: true; delay:  1250;")
				    document.querySelector('#mall_h13').setAttribute("animation", "property: visible; to: true; delay:  4000;")
				    document.querySelector('#h13_top').setAttribute("animation", "property: visible; to: true; delay:  7250;")
			    }
			})
		</script>
	        <link rel="stylesheet" href="index.css">
	</head>
	<body>
		<div id="photoModeContainer" style="display: none">
			<img id="photoModeImage">
			<div id="flash"></div>
			<div id="shutterButton" data-link="https://twitter.com/intent/tweet?text=Hello%20world&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo" style="">ツイート</div>
			<div id="closeButton" style=""></div>
		</div>
		<a-scene
		      xrweb="disableWorldTracking: true"
		      xrextras-almost-there
		      xrextras-runtime-error
		      xrextras-loading
		      photo-mode
		      tower>
			<a-assets>
				<a-asset-item id="ground" src="model/ground.glb"></a-asset-item>
				<a-asset-item id="mall" src="model/mall.glb"></a-asset-item>
				<a-asset-item id="mall_h13" src="model/mall_h13.glb"></a-asset-item>
				<a-asset-item id="h13_top" src="model/h13_top.glb"></a-asset-item>
				<a-asset-item id="tower1" src="model/01.glb"></a-asset-item>
				<a-asset-item id="tower2" src="model/02.glb"></a-asset-item>
				<a-asset-item id="tower3" src="model/03.glb"></a-asset-item>
				<a-asset-item id="tower4" src="model/04.glb"></a-asset-item>
				<a-asset-item id="tower5" src="model/05.glb"></a-asset-item>
				<a-asset-item id="tower6" src="model/06.glb"></a-asset-item>
				<a-asset-item id="tower7" src="model/07.glb"></a-asset-item>
				<a-asset-item id="tower8" src="model/08.glb"></a-asset-item>
				<a-asset-item id="tower9" src="model/09.glb"></a-asset-item>
				<a-asset-item id="tower10" src="model/10.glb"></a-asset-item>
				<a-asset-item id="tower11" src="model/11.glb"></a-asset-item>
				<a-asset-item id="tower12" src="model/12.glb"></a-asset-item>
				<a-asset-item id="tower13" src="model/13.glb"></a-asset-item>
				<a-asset-item id="tower14" src="model/14.glb"></a-asset-item>
				<a-asset-item id="tower15" src="model/15.glb"></a-asset-item>
				<a-asset-item id="tower16" src="model/16.glb"></a-asset-item>
				<a-asset-item id="tower17" src="model/17.glb"></a-asset-item>
				<a-asset-item id="tower18" src="model/18.glb"></a-asset-item>
				<a-asset-item id="tower19" src="model/19.glb"></a-asset-item>
				<a-asset-item id="tower20" src="model/20.glb"></a-asset-item>
				<a-asset-item id="tower21" src="model/21.glb"></a-asset-item>
				<a-asset-item id="tower22" src="model/22.glb"></a-asset-item>
				<a-asset-item id="tower23" src="model/23.glb"></a-asset-item>
				<a-asset-item id="tower24" src="model/24.glb"></a-asset-item>
				<a-asset-item id="tower25" src="model/25.glb"></a-asset-item>
				<a-asset-item id="tower26" src="model/26.glb"></a-asset-item>
				<a-asset-item id="tower27" src="model/27.glb"></a-asset-item>
				<a-asset-item id="tower28" src="model/28.glb"></a-asset-item>
				<a-asset-item id="tower29" src="model/29.glb"></a-asset-item>
				<a-asset-item id="tower30" src="model/30.glb"></a-asset-item>
				<a-asset-item id="tower31" src="model/31.glb"></a-asset-item>
				<a-asset-item id="tower32" src="model/32.glb"></a-asset-item>
				<a-asset-item id="tower33" src="model/33.glb"></a-asset-item>
				<!-- Credit to Tom Lechner by flickr: https://www.flickr.com/photos/tomlechner/9337477855/ -->
				<img id="backimage" src="image/9337477855_0e3fb2f77e_o.jpg"></img>
			</a-assets>

			<a-camera
				position="0 4 10"
			        raycaster="objects: .cantap"
				cursor="fuse: false; rayOrigin: mouse;">
			</a-camera>

			<a-light type="directional" intensity="0.5"
			       animation="property: position; from: -5 -5 5; to: 5 5 5; dur: 2000; easing: linear; dir: alternate; loop: true">
      			</a-light>

      			<a-light type="ambient" intensity="1"></a-light>

		        <a-sky src="#backimage" id="backimage" phi-length="360" phi-start="0" theta-length="90" theta-start="0"></a-sky>
		</a-scene>
	</body>
</html>
