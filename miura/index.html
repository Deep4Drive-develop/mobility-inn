<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
    		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	    	<meta name="apple-mobile-web-app-capable" content="yes">

		<title>(miura)デモページ</title>

		<script src="//cdn.8thwall.com/web/aframe/8frame-0.9.0.min.js"></script>
	        <script defer src="//cdn.8thwall.com/web/aframe/aframe-animation-component-5.1.2.min.js"></script>
	        <script src="//cdn.8thwall.com/web/aframe/aframe-extras-4.2.0.min.js"></script>
	    	<script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>

		<!-- 8th Wall API key -->
		<script async src="//apps.8thwall.com/xrweb?appKey=bnWBr8smMOtm8hsLzv1M3AsjyZEPcHize0Tqflu9nYQxqu0yf0fp8mul8iPtRtqb0oR3LW"></script>

		<script src="./js/oauth.min.js"></script>
        <script src="./js/sha1.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

		<script>
            //function twitter_init(detail) {
            function twitter_init() {
                OAuth.initialize('SyBFiEar-VxM_498UO4pywHi1Z0');
                OAuth.popup('twitter', function(err, result) {
                    b64pad = '=';

                    var url1 = "https://api.twitter.com/1.1/statuses/update.json";

                    var consumer_secret_key = "MD2fiy6v6RrPEHU7xSoLBDgJ8QWt4LFCK2cRDbWDaJIOeCr7GM";
                    var oauth_consumer_key = "c3f33vaqNN5xhDRVVXZ4j824T";
                    var oauth_nonce = String(Math.floor((new Date()).getTime()));
                    var oauth_signature; // 他の全てのリクエストパラメータと二つの秘密情報を署名アルゴリズムで処理して作成した値を設定します。
                    var oauth_signature_method = 'HMAC-SHA1';
                    var oauth_timestamp = String(Math.floor((new Date()).getTime() / 1000));
                    var oauth_token = result.oauth_token;
                    var oauth_version = "1.0";
                    var oauth_token_secret = result.oauth_token_secret;

                    var paramString = "";
                    paramString = paramString + "oauth_consumer_key=";
                    paramString = paramString + encodeURIComponent(oauth_consumer_key) + "&";
                    paramString = paramString + "oauth_nonce=";
                    paramString = paramString + encodeURIComponent(oauth_nonce) + "&";
                    paramString = paramString + "oauth_signature_method=";
                    paramString = paramString + encodeURIComponent(oauth_signature_method) + "&";
                    paramString = paramString + "oauth_timestamp=";
                    paramString = paramString + encodeURIComponent(oauth_timestamp) + "&";
                    paramString = paramString + "oauth_token=";
                    paramString = paramString + encodeURIComponent(oauth_token) + "&";
                    paramString = paramString + "oauth_version=";
                    paramString = paramString + encodeURIComponent(oauth_version) + "&";
                    paramString = paramString + "status=";
                    paramString = paramString + encodeURIComponent("hello");

                    var baseString = "POST";
                    baseString = baseString + "&";
                    baseString = baseString + encodeURIComponent(url1);
                    baseString = baseString + "&";
                    baseString = baseString + encodeURIComponent(paramString);
                    oauth_signature = b64_hmac_sha1(consumer_secret_key+"&"+oauth_token_secret, baseString);

                    var auth = "";
                    auth = auth + "OAuth ";
                    auth = auth + "oauth_consumer_key=";
                    auth = auth + encodeURIComponent(oauth_consumer_key) + ",";
                    auth = auth + "oauth_nonce=";
                    auth = auth + encodeURIComponent(oauth_nonce) + ",";
                    auth = auth + "oauth_signature_method=";
                    auth = auth + encodeURIComponent(oauth_signature_method) + ",";
                    auth = auth + "oauth_timestamp=";
                    auth = auth + encodeURIComponent(oauth_timestamp) + ",";
                    auth = auth + "oauth_token=";
                    auth = auth + encodeURIComponent(oauth_token) + ",";
                    auth = auth + "oauth_version=";
                    auth = auth + encodeURIComponent(oauth_version) + ",";
                    auth = auth + "status=";
                    auth = auth + encodeURIComponent("hello") + ",";
                    auth = auth + "oauth_signature=";
                    auth = auth + encodeURIComponent(oauth_signature);


                    var bound_text = "------------------------1ae47d990b354d1b00a4eea60e6b5b72";
                    var image_src = "--" + bound_text + "\r\n" +
                        'Content-Disposition: form-data; name="media_data"' + "\r\n" +
                        "\r\n" +
                        detail + "\r\n" + "--" + bound_text + "--\r\n\r\n";
                    var param1 = {
                        headers: {
                            'Content-Type' : 'multipart/form-data; boundary=' + bound_text
                        },
                        data: image_src
                    };
                    result.post('https://upload.twitter.com/1.1/media/upload.json', param1).done(function (response) {
                        var media_id_ = response.data.media_id_string;
                        var param = {
                            data: {
                                status: "hello",
                                media_id: media_id_
                            }
                        };
                        result.post('/1.1/statuses/update.json', param).done(function (response) {
                            console.log("success");
                            console.log(response);
                        }).fail(function (err) {
                            console.log("err1");
                            console.log(err);
                        });
                    }).fail(function(err) {
                        console.log("err2");
                        console.log(err);
                    }

                    // timeout : 30s
                    /*
                    $.ajax({
                        method: "POST",
                        timeout: 30000,
                        url: url1,
                        headers: {
                            Authorization: auth
                        },
                        data: "status=hello"
                    }).done(function(data, textStatus, jqXHR) {
                        var link_text = "https://twitter.com/intent/tweet?text=SUCCESS(update):";
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        var link_text = "https://twitter.com/intent/tweet?text=ERROR(update):";
                    });
                    */

                }).fail(function(err){
                    var link_text = "https://twitter.com/intent/tweet?text=ERROR(popup):" + err.body.errors.message;
                    location.href = link_text;
                });
            }
            AFRAME.registerComponent('photo-mode', {
                init: function() {
                    const container = document.getElementById('photoModeContainer');
                    const image = document.getElementById('photoModeImage');
                    const shutterButton = document.getElementById('shutterButton');
                    const closeButton = document.getElementById('closeButton');

                    // Container starts hidden so it isn't visible when the page is still loading
                    container.style.display = 'block';

                    closeButton.addEventListener('click', () => {
                        container.classList.remove('photo');
                    })

                    shutterButton.addEventListener('click', () => {
                        // Emit a screenshotrequest to the xrweb component
                        this.el.sceneEl.emit('screenshotrequest');

                        // Show the flash while the image is being taken
                        container.classList.add('flash');
                    })

                    this.el.sceneEl.addEventListener('screenshotready', e => {
                        container.classList.remove('flash');
                        // If an error occurs while trying to take the screenshot, e.detail will be empty.
                        // We could either retry or return control to the user
                        if (!e.detail) {
                            return;
                        }

                        twitter_init(e.detail);

                        // e.detail is the base64 representation of the JPEG screenshot
                        image.src = 'data:image/jpeg;base64,' + e.detail;
                        var a = document.createElement('a');
                        a.href = image.src;
                        a.download = "download.jpg";
                        a.click();

                        // Show the photo
                        container.classList.add('photo');

                        //var link = this.getAttribute('data-link');
                        //link = "https://twitter.com/intent/tweet?text=あなたの東京タワーにまつわる思い出を投稿しよう！&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo";
                        //link = "https://twitter.com/intent/tweet?text="+message+"あなたの東京タワーにまつわる思い出を投稿しよう！&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo";
                        //location.href = link;
                    })
                }
            })

			AFRAME.registerComponent('tower', {
                schema: {
                    name: { type: 'string' }
                },
                init: function() {
                    var scene = document.querySelector('a-scene');

                    var model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#ground');
                    model.setAttribute('id', 'ground');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    //model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#mall');
                    model.setAttribute('id', 'mall');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#mall_h13');
                    model.setAttribute('id', 'mall_h13');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#h13_top');
                    model.setAttribute('id', 'h13_top');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    for(var i = 1; i <= 33; i++) {
                        var tower_ = document.createElement('a-gltf-model');
                        tower_.setAttribute('src', '#tower' + String(i));
                        tower_.setAttribute('id', 'tower_' + String(i));
                        tower_.setAttribute('scale', '0.0125 0.0125 0.0125');
                        tower_.setAttribute("visible", "false");
                        scene.appendChild(tower_);
                    }

                    document.querySelector('#ground').setAttribute("visible", "true");
                    for(var i = 1; i <= 33; i++) {
                        document.querySelector('#tower_'+String(i)).setAttribute("animation", "property: visible; to: true; delay: " + String(250*i) + ";");
                    }
                    document.querySelector('#mall').setAttribute("animation", "property: visible; to: true; delay:  1250;")
                    document.querySelector('#mall_h13').setAttribute("animation", "property: visible; to: true; delay:  4000;")
                    document.querySelector('#h13_top').setAttribute("animation", "property: visible; to: true; delay:  7250;")

                }
			})

            /*
            b64pad = '=';
            var url1 = "https://api.twitter.com/1.1/statuses/update.json";

            var consumer_secret_key = "MD2fiy6v6RrPEHU7xSoLBDgJ8QWt4LFCK2cRDbWDaJIOeCr7GM";
            var oauth_consumer_key = "c3f33vaqNN5xhDRVVXZ4j824T";
            var oauth_nonce = String(Math.floor((new Date()).getTime()));
            var oauth_signature; 
            var oauth_signature_method = 'HMAC-SHA1';
            var oauth_timestamp = String(Math.floor((new Date()).getTime() / 1000));
            var oauth_token = "6065472-jxDzenRRBsKjdqwDdwPmJtG0CEi6kI8yycUblT7PlL";
            var oauth_version = "1.0";
            var oauth_token_secret = "0KTgPp8demFhL21C2oA0IKGlJGg5uVj64JyUdSsgeIiGU";

            var paramString = "";
            paramString = paramString + "oauth_consumer_key=";
            paramString = paramString + encodeURIComponent(oauth_consumer_key) + "&";
            paramString = paramString + "oauth_nonce=";
            paramString = paramString + encodeURIComponent(oauth_nonce) + "&";
            paramString = paramString + "oauth_signature_method=";
            paramString = paramString + encodeURIComponent(oauth_signature_method) + "&";
            paramString = paramString + "oauth_timestamp=";
            paramString = paramString + encodeURIComponent(oauth_timestamp) + "&";
            paramString = paramString + "oauth_token=";
            paramString = paramString + encodeURIComponent(oauth_token) + "&";
            paramString = paramString + "oauth_version=";
            paramString = paramString + encodeURIComponent(oauth_version) + "&";
            paramString = paramString + "status=";
            paramString = paramString + encodeURIComponent("hello");

            var baseString = "POST";
            baseString = baseString + "&";
            baseString = baseString + encodeURIComponent(url1);
            baseString = baseString + "&";
            baseString = baseString + encodeURIComponent(paramString);
            oauth_signature = b64_hmac_sha1(consumer_secret_key+"&"+oauth_token_secret, baseString);

            var auth = "";
            auth = auth + "OAuth ";
            auth = auth + "oauth_consumer_key=";
            auth = auth + encodeURIComponent(oauth_consumer_key) + ",";
            auth = auth + "oauth_nonce=";
            auth = auth + encodeURIComponent(oauth_nonce) + ",";
            auth = auth + "oauth_signature_method=";
            auth = auth + encodeURIComponent(oauth_signature_method) + ",";
            auth = auth + "oauth_timestamp=";
            auth = auth + encodeURIComponent(oauth_timestamp) + ",";
            auth = auth + "oauth_token=";
            auth = auth + encodeURIComponent(oauth_token) + ",";
            auth = auth + "oauth_version=";
            auth = auth + encodeURIComponent(oauth_version) + ",";
            auth = auth + "status=";
            auth = auth + encodeURIComponent("hello") + ",";
            auth = auth + "oauth_signature=";
            auth = auth + encodeURIComponent(oauth_signature);

            console.log(auth);

            $.ajax({
                method: "POST",
                url: url1,
                headers: {
                    Authorization: auth
                },
                data: "status=hello"
            }).done(function(data, textStatus, jqXHR) {
                var link_text = "https://twitter.com/intent/tweet?text=SUCCESS(update):";
                //location.href = link_text;
            }).fail(function(jqXHR, textStatus, errorThrown) {
                var link_text = "https://twitter.com/intent/tweet?text=ERROR(update):";
                //location.href = link_text;
            });
            */

            twitter_init();
		</script>
        <link rel="stylesheet" href="index.css">
	</head>
	<body>
		<div id="photoModeContainer" style="display: none">
			<img id="photoModeImage">
			<div id="flash"></div>
			<div id="shutterButton" data-link="https://twitter.com/intent/tweet?text=Hello%20world&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo" style="">ツイート</div>
			<div id="closeButton" style=""></div>
		</div>
		<a-scene
		      xrweb="disableWorldTracking: true"
		      xrextras-almost-there
		      xrextras-runtime-error
		      xrextras-loading
		      photo-mode
		      tower>
			<a-assets>
				<a-asset-item id="ground" src="model/ground.glb"></a-asset-item>
				<a-asset-item id="mall" src="model/mall.glb"></a-asset-item>
				<a-asset-item id="mall_h13" src="model/mall_h13.glb"></a-asset-item>
				<a-asset-item id="h13_top" src="model/h13_top.glb"></a-asset-item>
				<a-asset-item id="tower1" src="model/01.glb"></a-asset-item>
				<a-asset-item id="tower2" src="model/02.glb"></a-asset-item>
				<a-asset-item id="tower3" src="model/03.glb"></a-asset-item>
				<a-asset-item id="tower4" src="model/04.glb"></a-asset-item>
				<a-asset-item id="tower5" src="model/05.glb"></a-asset-item>
				<a-asset-item id="tower6" src="model/06.glb"></a-asset-item>
				<a-asset-item id="tower7" src="model/07.glb"></a-asset-item>
				<a-asset-item id="tower8" src="model/08.glb"></a-asset-item>
				<a-asset-item id="tower9" src="model/09.glb"></a-asset-item>
				<a-asset-item id="tower10" src="model/10.glb"></a-asset-item>
				<a-asset-item id="tower11" src="model/11.glb"></a-asset-item>
				<a-asset-item id="tower12" src="model/12.glb"></a-asset-item>
				<a-asset-item id="tower13" src="model/13.glb"></a-asset-item>
				<a-asset-item id="tower14" src="model/14.glb"></a-asset-item>
				<a-asset-item id="tower15" src="model/15.glb"></a-asset-item>
				<a-asset-item id="tower16" src="model/16.glb"></a-asset-item>
				<a-asset-item id="tower17" src="model/17.glb"></a-asset-item>
				<a-asset-item id="tower18" src="model/18.glb"></a-asset-item>
				<a-asset-item id="tower19" src="model/19.glb"></a-asset-item>
				<a-asset-item id="tower20" src="model/20.glb"></a-asset-item>
				<a-asset-item id="tower21" src="model/21.glb"></a-asset-item>
				<a-asset-item id="tower22" src="model/22.glb"></a-asset-item>
				<a-asset-item id="tower23" src="model/23.glb"></a-asset-item>
				<a-asset-item id="tower24" src="model/24.glb"></a-asset-item>
				<a-asset-item id="tower25" src="model/25.glb"></a-asset-item>
				<a-asset-item id="tower26" src="model/26.glb"></a-asset-item>
				<a-asset-item id="tower27" src="model/27.glb"></a-asset-item>
				<a-asset-item id="tower28" src="model/28.glb"></a-asset-item>
				<a-asset-item id="tower29" src="model/29.glb"></a-asset-item>
				<a-asset-item id="tower30" src="model/30.glb"></a-asset-item>
				<a-asset-item id="tower31" src="model/31.glb"></a-asset-item>
				<a-asset-item id="tower32" src="model/32.glb"></a-asset-item>
				<a-asset-item id="tower33" src="model/33.glb"></a-asset-item>
				<!-- Credit to Tom Lechner by flickr: https://www.flickr.com/photos/tomlechner/9337477855/ -->
				<img id="backimage" src="image/9337477855_0e3fb2f77e_o.jpg"></img>
			</a-assets>

			<a-camera
				position="0 4 10"
			        raycaster="objects: .cantap"
				cursor="fuse: false; rayOrigin: mouse;">
			</a-camera>

			<a-light type="directional" intensity="0.5"
			       animation="property: position; from: -5 -5 5; to: 5 5 5; dur: 2000; easing: linear; dir: alternate; loop: true">
      			</a-light>

      			<a-light type="ambient" intensity="1"></a-light>

		        <a-sky src="#backimage" id="backimage" phi-length="360" phi-start="0" theta-length="90" theta-start="0"></a-sky>
		</a-scene>
	</body>
</html>
