<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <title>(miura)デモページ</title>

        <script src="//cdn.8thwall.com/web/aframe/8frame-0.9.0.min.js"></script>
        <script defer src="//cdn.8thwall.com/web/aframe/aframe-animation-component-5.1.2.min.js"></script>
        <script src="//cdn.8thwall.com/web/aframe/aframe-extras-4.2.0.min.js"></script>
        <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>

        <!-- 8th Wall API key -->
        <script async src="//apps.8thwall.com/xrweb?appKey=k5cXnRU1Uvm1gSlh66K6wcqBczvn7sGxjIBoJasdLNJzDDEvPAl8F9bNoJwdtfgSh4t2Kz"></script>

        <script src="./js/oauth.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

        <script>
            function twitter_init(detail, tweet_text) {
                OAuth.initialize('SyBFiEar-VxM_498UO4pywHi1Z0');
                OAuth.popup('twitter').then(function(result) {

                    var bound_text = "------------------------1ae47d990b354d1b00a4eea60e6b5b72";
                    var image_src = "--" + bound_text + "\r\n" +
                        'Content-Disposition: form-data; name="media_data"' + "\r\n" +
                        "\r\n" +
                        detail + "\r\n" + "--" + bound_text + "--\r\n\r\n";
                    var param1 = {
                        headers: {
                            'Content-Type' : 'multipart/form-data; boundary=' + bound_text
                        },
                        data: image_src
                    };
                    result.post('https://upload.twitter.com/1.1/media/upload.json', param1).done(function (response) {
                        console.log(response);
                        var media_id_ = response.media_id_string;
                        var param = {
                            data: {
                                status: tweet_text,
                                media_ids: media_id_
                            }
                        };
                        result.post('/1.1/statuses/update.json', param).done(function (response) {
                            console.log("success");
                            console.log(response);
                        }).fail(function (err) {
                            console.log("err1");
                            console.log(err);
                        });
                    }).fail(function(err) {
                        console.log("err2");
                        console.log(err);
                    });

                }).fail(function(err){
                    console.log("err3");
                    console.log(err);
                });
            }

            AFRAME.registerComponent('photo-mode', {
                init: function() {
                    const container = document.getElementById('photoModeContainer');
                    const image = document.getElementById('photoModeImage');
                    const shutterButton = document.getElementById('shutterButton');
                    const closeButton = document.getElementById('closeButton');
                    const actionButton = document.getElementById('actionButton');
                    const tweetButton = document.getElementById('tweetButton');
                    const tweet2Button = document.getElementById('tweet2Button');
                    const tweet3Button = document.getElementById('tweet3Button');
                    const tweet3CancelButton = document.getElementById('tweet3CancelButton');
                    const tweet3Text = document.getElementById('tweet3Text');

                    var photo_image;
            
                    // Container starts hidden so it isn't visible when the page is still loading
                    container.style.display = 'block';
            
                    closeButton.addEventListener('click', () => {
                        container.classList.remove('photo');
                    })

                    actionButton.addEventListener('click', () => {
                        //container.classList.add('photo');
                    })

                    tweetButton.addEventListener('click', () => {
                        var link = "https://twitter.com/intent/tweet?text=あなたの東京タワーにまつわる思い出を投稿しよう！&url=https%3A%2F%2Fdeep4drive-develop.github.io%2Fmobility-inn%2F&hashtags=demo";
                        location.href = link;

                        //container.classList.add('photo');
                    })
            
                    tweet2Button.addEventListener('click', () => {
                        container.classList.add('tweet');
                        //tweet3Text.disabled=false;
                    })

                    tweet3Button.addEventListener('click', () => {
                        twitter_init(photo_image, tweet3Text.value);
                        //twitter_init(photo_image, "test");
                        container.classList.remove('tweet');
                    })

                    tweet3CancelButton.addEventListener('click', () => {
                        //tweet3Text.disabled=true;
                        container.classList.remove('tweet');
                    })
            
                    shutterButton.addEventListener('click', () => {
                        // Emit a screenshotrequest to the xrweb component
                        this.el.sceneEl.emit('screenshotrequest');
            
                        // Show the flash while the image is being taken
                        container.classList.add('flash');
                    })
            
                    this.el.sceneEl.addEventListener('screenshotready', e => {
                        container.classList.remove('flash');
                        // If an error occurs while trying to take the screenshot, e.detail will be empty.
                        // We could either retry or return control to the user
                        if (!e.detail) {
                            return;
                        }
                        photo_image = e.detail;

                        // e.detail is the base64 representation of the JPEG screenshot
                        image.src = 'data:image/jpeg;base64,' + e.detail;

                        // photo download
                        // var a = document.createElement('a');
                        // a.href = image.src;
                        // a.download = "download.jpg";
                        // a.click();
            
                        // Show the photo
                        container.classList.add('photo');
                    })
                }
            })
            
            AFRAME.registerComponent('tower', {
                schema: {
                    name: { type: 'string' }
                },
                init: function() {
                    var scene = document.querySelector('a-scene');
            
                    var model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#ground');
                    model.setAttribute('id', 'ground');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    //model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#mall');
                    model.setAttribute('id', 'mall');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    model.setAttribute("visible", "false");
                    scene.appendChild(model);
                    model = document.createElement('a-gltf-model');
                    model.setAttribute('src', '#mall_h13');
                    model.setAttribute('id', 'mall_h13');
                    model.setAttribute('scale', '0.0125 0.0125 0.0125');
                    model.setAttribute("visible", "false");
                    scene.appendChild(model);
            
                    document.querySelector('#ground').setAttribute("visible", "true");
                    for(var i = 1; i <= 33; i++) {
                        document.querySelector('#tower_'+String(i)).setAttribute("animation", "property: visible; to: true; delay: " + String(250*i) + ";");
                    }
                    document.querySelector('#mall').setAttribute("animation", "property: visible; to: true; delay:  1250;")
                    document.querySelector('#mall_h13').setAttribute("animation", "property: visible; to: true; delay:  4000;")
            
                }
            })

        </script>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <div id="photoModeContainer" style="display: none">
            <img id="photoModeImage">
            <div id="flash"></div>
            <div id="shutterButton"></div>
            <div id="closeButton"></div>
            <div id="actionButton">ACTION</div>
            <div id="tweetButton">TWEET</div>
            <div id="tweet2Button">TWEET &gt;</div>
            <textarea id="tweet3Text" cols="33" rows="5">test message</textarea>
            <div id="tweet3Button">TWEET</div>
            <div id="tweet3CancelButton">Cancel</div>

            <div id="topGuide">かざしてみてください</div>
        </div>
        <a-scene
            xrweb="disableWorldTracking: true"
            xrextras-almost-there
            xrextras-runtime-error
            xrextras-loading
            photo-mode
            tower>
            <a-assets>
                <a-asset-item id="ground" src="model/ground.glb"></a-asset-item>
                <a-asset-item id="mall" src="model/mall.glb"></a-asset-item>
                <a-asset-item id="mall_h13" src="model/mall_h13.glb"></a-asset-item>
                <!-- Credit to Tom Lechner by flickr: https://www.flickr.com/photos/tomlechner/9337477855/ -->
                <img id="backimage" src="image/9337477855_0e3fb2f77e_o.jpg"></img>
            </a-assets>

            <a-camera
                position="0 4 10"
                raycaster="objects: .cantap"
                cursor="fuse: false; rayOrigin: mouse;">
            </a-camera>

            <a-light type="directional"
                     intensity="0.5"
                     animation="property: position; from: -5 -5 5; to: 5 5 5; dur: 2000; easing: linear; dir: alternate; loop: true">
            </a-light>

            <a-light type="ambient" intensity="1"></a-light>

            <a-sky src="#backimage" id="backimage" phi-length="360" phi-start="0" theta-length="90" theta-start="0"></a-sky>
        </a-scene>
    </body>
</html>
